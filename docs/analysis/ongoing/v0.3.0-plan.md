# v0.3.0 Release Plan - Breaking Changes

**Created:** 2025-12-14
**Last Updated:** 2025-12-25
**Target Release:** Q2 2026 (after v0.2.x matures)
**Type:** MAJOR - Breaking Changes
**Status:** Planning Phase - **MAJOR REVISION REQUIRED**

---

## ‚ö†Ô∏è **CRITICAL UPDATE (2025-12-25)**

**The Custom Error Type (PfcpError) feature is 80%+ implemented in v0.2.5!**

This plan requires **significant revision** as Phase 1 (Custom Error Type) is no longer part of v0.3.0 scope.

### üéØ What's Changed:

**REMOVED from v0.3.0 Scope:**
- ‚ùå ~~Section 1: Custom Error Type (PfcpError)~~ ‚Üí **Already in v0.2.5!**
- ‚ùå ~~Phase 1 implementation plan (6-8 days)~~ ‚Üí **Already spent in v0.2.5**
- ‚ùå ~~"Replace io::Error with PfcpError"~~ ‚Üí **76+ files already migrated**

**STILL IN v0.3.0 Scope:**
- ‚úÖ Newtype Wrappers (still valid - not started)
- ‚úÖ Remove Deprecated Methods (still valid)
- ‚ö†Ô∏è **Complete PfcpError migration** (finish remaining 20%)
  - Message layer completion
  - Builder migration completion
  - Test suite updates
  - Examples and documentation

### üìä Impact on Timeline:

**Original Estimate:** 10-14 days total
**Actual Adjustment:**
- Phase 1 (Custom Error): ~~6-8 days~~ ‚Üí **Already spent in v0.2.5**
- Phase 2 (Newtypes): 2-3 days ‚Üí **Still valid**
- Phase 3 (Cleanup): 2-3 days ‚Üí **Still valid**
- **New: Complete PfcpError (20%):** +2-3 days

**Revised Estimate:** 6-9 days + 2-4 weeks community feedback

---

## üìã Executive Summary (REVISED)

v0.3.0 will be the **first major breaking release** since v0.2.0, focusing on **type safety** and **completing error handling migration**. This release bundles remaining breaking changes from the API improvements roadmap.

**Revised Goals:**

1. ‚úÖ **Complete PfcpError migration** (finish remaining 20% from v0.2.5)
2. ‚úÖ Add newtype wrappers for type-safe primitives
3. ‚úÖ Remove deprecated methods from v0.2.x
4. ‚úÖ Maintain 100% test coverage
5. ‚úÖ Provide clear migration guide

**Timeline:** 6-9 days development + 2-4 weeks community feedback
**Risk:** LOW-MEDIUM (smaller scope, most error work done)

---

## üéØ Core Features

### 1. ~~Custom Error Type (`PfcpError`)~~ - **80%+ COMPLETE IN v0.2.5** ‚úÖ

**NOTE:** This section is kept for historical reference. The feature described below is largely implemented in v0.2.5. See custom-error-type.md for full implementation details.

**What's Done in v0.2.5:**
- ‚úÖ PfcpError enum with 8 variants (src/error.rs)
- ‚úÖ 76+ files migrated (IE layer 80%+ complete)
- ‚úÖ 3GPP Cause code mapping
- ‚úÖ Rich error context

**What Remains for v0.3.0 (20%):**
- Complete message layer migration
- Finish builder migration
- Update all test assertions
- Add error handling examples

---

### Original Feature Description (Mostly Implemented):

**Current Problem:**

```rust
// ‚ùå All errors are generic io::Error
pub fn unmarshal(data: &[u8]) -> Result<Self, io::Error> {
    Err(io::Error::new(io::ErrorKind::InvalidData, "Missing PDR ID"))
}

// ‚ùå Users must parse error strings (brittle!)
match msg.unmarshal(data) {
    Err(e) if e.to_string().contains("Missing PDR ID") => { /* ... */ }
}
```

**Proposed Solution:**

```rust
// ‚úÖ Structured error type with rich context
pub enum PfcpError {
    /// IE parsing errors
    IeParseError {
        ie_type: IeType,
        reason: String,
        offset: Option<usize>,
    },

    /// Missing mandatory IE
    MissingMandatoryIe {
        ie_type: IeType,
        message_type: Option<MsgType>,
    },

    /// Invalid field value
    InvalidValue {
        field: String,
        expected: String,
        got: String,
    },

    /// Validation errors (builders)
    ValidationError {
        message: String,
    },

    /// UTF-8 encoding errors
    EncodingError {
        source: std::str::Utf8Error,
    },

    /// Underlying I/O errors
    IoError {
        source: io::Error,
    },
}

impl std::error::Error for PfcpError { /* ... */ }
impl Display for PfcpError { /* ... */ }
impl From<io::Error> for PfcpError { /* ... */ }
impl From<std::str::Utf8Error> for PfcpError { /* ... */ }
```

**Benefits:**

- ‚úÖ **Pattern matching** on error types
- ‚úÖ **Error recovery** - handle specific cases
- ‚úÖ **Better debugging** - structured context
- ‚úÖ **3GPP mapping** - can map to PFCP Cause codes
- ‚úÖ **Error chains** - preserve error context

**Implementation Leverage:**

- ‚úÖ v0.2.4 already has error message constants in `src/error.rs`
- ‚úÖ Just need to add enum and migrate call sites
- ‚úÖ Message constants directly map to error variants

**Effort:** 3-4 days
**Files Affected:** ~150 files (all marshal/unmarshal implementations)
**Breaking:** Yes (changes all `Result<T, io::Error>` ‚Üí `Result<T, PfcpError>`)

---

---

### 2. Newtype Wrappers - **NOW PRIMARY FEATURE FOR v0.3.0** üéØ

**Current Problem:**

```rust
// ‚ùå Easy to swap arguments (both are primitives)
SessionEstablishmentRequest::new(1234, 5678);  // Which is SEID? Which is sequence?
SessionEstablishmentRequest::new(5678, 1234);  // Compiles but wrong!

// ‚ùå No semantic meaning
let seid: u64 = 0x123456789ABCDEF0;
let teid: u32 = 0x12345678;
let seq: u32 = 42;
// All primitives - easy to mix up
```

**Proposed Solution:**

```rust
// ‚úÖ Type-safe newtypes
#[derive(Debug, Clone, Copy, PartialEq, Eq, PartialOrd, Ord, Hash)]
pub struct Seid(pub u64);

#[derive(Debug, Clone, Copy, PartialEq, Eq, PartialOrd, Ord, Hash)]
pub struct SequenceNumber(pub u32);

#[derive(Debug, Clone, Copy, PartialEq, Eq, PartialOrd, Ord, Hash)]
pub struct Teid(pub u32);

impl Seid {
    pub const fn new(value: u64) -> Self { Self(value) }
    pub const fn value(&self) -> u64 { self.0 }
}

// ‚úÖ Compiler prevents swapping
SessionEstablishmentRequest::new(
    Seid::new(0x123456789ABCDEF0),
    SequenceNumber::new(42)
);  // Type-safe!

SessionEstablishmentRequest::new(
    SequenceNumber::new(42),  // ‚ùå Compile error!
    Seid::new(0x123456789ABCDEF0)
);
```

**Types to Wrap:**

| Type | Inner | Priority | Usage |
|------|-------|----------|-------|
| `Seid` | `u64` | HIGH | Session Endpoint ID - used in 12+ messages |
| `SequenceNumber` | `u32` | HIGH | Message sequence - used in all messages |
| `Teid` | `u32` | HIGH | Tunnel Endpoint ID - F-TEID IE |
| `Priority` | `u8` | MEDIUM | QoS priority values |

**Note:** `Precedence` already exists as a proper type! ‚úÖ

**Benefits:**

- ‚úÖ **Compile-time safety** - prevent argument swapping
- ‚úÖ **Self-documenting** - clear semantic meaning
- ‚úÖ **Validation** - can add constructors that validate ranges
- ‚úÖ **Domain logic** - can add impl blocks for conversions

**Effort:** 1-2 days
**Files Affected:** ~40 files (message constructors, builders)
**Breaking:** Yes (changes constructor signatures)

---

### 3. Remove Deprecated Methods - LOW PRIORITY

**Cleanup deprecated APIs from v0.2.x:**

```rust
// Remove these deprecated methods (added in v0.2.2):
- Message::find_ie()         // Use: ies(ie_type).next()
- Message::find_all_ies()    // Use: ies(ie_type).collect()
```

**Deprecation Timeline:**

- v0.2.2 (2025-12-05): Methods marked `#[deprecated]`
- v0.2.3-v0.2.5: Deprecation warnings guide users
- v0.3.0: Remove deprecated methods entirely

**Effort:** 0.5 days (straightforward removal)
**Files Affected:** ~30 files (message types + trait)
**Breaking:** Yes (removes deprecated methods)

---

## üìÖ Implementation Plan

### Phase 1: Custom Error Type (Week 1-2)

**Task 1.1: Design PfcpError Enum (1 day)**

- [ ] Define error variants (leverage v0.2.4 error message patterns)
- [ ] Design error context structures
- [ ] Plan 3GPP Cause code mapping
- [ ] Review with stakeholders

**Task 1.2: Implement Core Error Type (1 day)**

- [ ] Create `PfcpError` enum in `src/error.rs`
- [ ] Add `Display`, `Error`, `From` implementations
- [ ] Add error conversion helpers
- [ ] Add comprehensive unit tests

**Task 1.3: Migrate IE Files (2-3 days)**

- [ ] Batch 1: Simple IEs (30 files) - unmarshal only
- [ ] Batch 2: Complex IEs (30 files) - unmarshal + validation
- [ ] Batch 3: Grouped IEs (25 files) - child IE errors
- [ ] Batch 4: Special cases (remaining files)
- [ ] Run tests after each batch

**Task 1.4: Migrate Message Files (1-2 days)**

- [ ] Update all 26 message types
- [ ] Update message parsing functions
- [ ] Update builder validation errors
- [ ] Ensure error context is preserved

**Task 1.5: Update Examples & Tests (1 day)**

- [ ] Update all 15+ examples
- [ ] Fix test error assertions
- [ ] Add error-handling examples
- [ ] Document migration patterns

**Phase 1 Total:** 6-8 days

---

### Phase 2: Newtype Wrappers (Week 2)

**Task 2.1: Create Newtype Definitions (0.5 days)**

- [ ] Create `src/types.rs` with newtype wrappers
- [ ] Add `Seid`, `SequenceNumber`, `Teid`, `Priority`
- [ ] Implement std traits (Debug, Clone, Eq, Ord, Hash)
- [ ] Add const constructors and accessors
- [ ] Add comprehensive tests

**Task 2.2: Migrate Message Constructors (1 day)**

- [ ] Update all 26 message type constructors
- [ ] Update message builders
- [ ] Update `Message` trait if needed
- [ ] Run tests after each message type

**Task 2.3: Migrate IE Constructors (0.5 days)**

- [ ] Update F-TEID (uses Teid)
- [ ] Update F-SEID (uses Seid)
- [ ] Update other IEs as needed
- [ ] Run tests

**Task 2.4: Update Examples (0.5 days)**

- [ ] Update all examples with new types
- [ ] Add type-safety demonstration examples
- [ ] Update documentation

**Phase 2 Total:** 2-3 days

---

### Phase 3: Cleanup & Polish (Week 2-3)

**Task 3.1: Remove Deprecated Methods (0.5 days)**

- [ ] Remove `find_ie()` and `find_all_ies()`
- [ ] Update any remaining call sites
- [ ] Run full test suite

**Task 3.2: Documentation (1 day)**

- [ ] Write migration guide (`docs/guides/v0.3.0-migration.md`)
- [ ] Update CHANGELOG.md
- [ ] Update README with breaking changes
- [ ] Update API documentation
- [ ] Add "What's New in v0.3.0" guide

**Task 3.3: Testing & Validation (1 day)**

- [ ] Run full test suite (all 2,367 tests)
- [ ] Run benchmarks (ensure no regression)
- [ ] Manual testing of examples
- [ ] Compile with latest Rust stable

**Task 3.4: Community Review (2-4 weeks)**

- [ ] Create v0.3.0-rc.1 release candidate
- [ ] Announce in discussions/issues
- [ ] Gather feedback
- [ ] Fix any issues found
- [ ] Create v0.3.0-rc.2 if needed

**Phase 3 Total:** 2-3 days + 2-4 weeks feedback

---

## üìä Effort Summary (REVISED FOR v0.2.5 COMPLETION)

| Phase | Task | Effort | Risk | Status |
|-------|------|--------|------|--------|
| **~~Phase 1~~** | ~~Custom Error Type~~ | ~~6-8 days~~ | ~~MEDIUM~~ | **‚úÖ DONE in v0.2.5** |
| **Phase 1 (New)** | Complete PfcpError (20%) | 2-3 days | LOW | Pending |
| **Phase 2** | Newtype Wrappers | 2-3 days | LOW | Pending |
| **Phase 3** | Cleanup & Polish | 2-3 days | LOW | Pending |
| **Community** | Review Period | 2-4 weeks | LOW | Pending |
| **Total** | Development | **6-9 days** | **LOW-MEDIUM** | **Reduced!** |

**Savings:** 6-8 days already spent in v0.2.5 means v0.3.0 is now faster to complete!

**Calendar Timeline:**

- Week 1-2: Phase 1 (Custom Error Type)
- Week 2: Phase 2 (Newtype Wrappers)
- Week 2-3: Phase 3 (Cleanup & Documentation)
- Week 4-8: Community review & feedback
- Week 8-9: Final release

**Target Release:** 8-10 weeks from start

---

## üéØ Success Criteria

### Must Have ‚úÖ

- [ ] All 2,367+ tests passing
- [ ] Zero clippy warnings
- [ ] All examples compile and run
- [ ] Migration guide is complete and tested
- [ ] CHANGELOG documents all breaking changes
- [ ] Performance: No regressions (benchmarks within 5%)

### Should Have üìã

- [ ] Community feedback incorporated
- [ ] At least 2 weeks of rc testing
- [ ] Migration tested on real projects
- [ ] Error messages are helpful and consistent

### Nice to Have üåü

- [ ] Error type examples in docs/guides
- [ ] YouTube video explaining migration
- [ ] Blog post about type safety improvements

---

## ‚ö†Ô∏è Risks & Mitigation

### Risk 1: Breaking Changes Impact Users
**Likelihood:** HIGH
**Impact:** MEDIUM
**Mitigation:**

- ‚úÖ Provide comprehensive migration guide
- ‚úÖ Release candidate period for feedback
- ‚úÖ Clear deprecation timeline (v0.2.2 ‚Üí v0.3.0)
- ‚úÖ Document all breaking changes in CHANGELOG

### Risk 2: Error Type Complexity
**Likelihood:** MEDIUM
**Impact:** MEDIUM
**Mitigation:**

- ‚úÖ Leverage existing error message constants from v0.2.4
- ‚úÖ Start with simple enum, can expand later
- ‚úÖ Provide From<io::Error> for backward compat in some places

### Risk 3: Performance Regression
**Likelihood:** LOW
**Impact:** HIGH
**Mitigation:**

- ‚úÖ Newtype wrappers are zero-cost
- ‚úÖ Error type uses enums (efficient)
- ‚úÖ Run benchmarks before/after
- ‚úÖ Only accept if performance within 5%

### Risk 4: Community Resistance
**Likelihood:** LOW
**Impact:** MEDIUM
**Mitigation:**

- ‚úÖ Clear communication about benefits
- ‚úÖ Migration guide with examples
- ‚úÖ RC period for feedback
- ‚úÖ Be willing to adjust based on feedback

---

## üì¶ Migration Guide Preview

### For Users of rs-pfcp

**Updating Error Handling:**

```rust
// Before (v0.2.x)
match msg.unmarshal(data) {
    Ok(msg) => process(msg),
    Err(e) => eprintln!("Error: {}", e),
}

// After (v0.3.0) - Option 1: Simple migration
match msg.unmarshal(data) {
    Ok(msg) => process(msg),
    Err(e) => eprintln!("Error: {}", e),  // Still works!
}

// After (v0.3.0) - Option 2: Structured handling
use rs_pfcp::error::PfcpError;

match msg.unmarshal(data) {
    Ok(msg) => process(msg),
    Err(PfcpError::MissingMandatoryIe { ie_type, .. }) => {
        eprintln!("Missing required IE: {:?}", ie_type);
        // Can send appropriate PFCP error response
    }
    Err(PfcpError::IeParseError { ie_type, reason, .. }) => {
        eprintln!("Failed to parse {:?}: {}", ie_type, reason);
    }
    Err(e) => eprintln!("Other error: {}", e),
}
```

**Updating Constructors:**

```rust
// Before (v0.2.x)
let req = SessionEstablishmentRequest::new(seid_u64, seq_u32);

// After (v0.3.0)
use rs_pfcp::types::{Seid, SequenceNumber};
let req = SessionEstablishmentRequest::new(
    Seid::new(seid_u64),
    SequenceNumber::new(seq_u32)
);

// Or use From trait
let req = SessionEstablishmentRequest::new(
    seid_u64.into(),  // Implements From<u64> for Seid
    seq_u32.into()    // Implements From<u32> for SequenceNumber
);
```

**Updating Iterator Usage:**

```rust
// Before (v0.2.x) - deprecated but still works
let pdr = msg.find_ie(IeType::CreatePdr);

// After (v0.3.0) - use iterator API
let pdr = msg.ies(IeType::CreatePdr).next();
```

---

## üîÑ Alternative: Incremental Approach

**If 10-14 days is too much at once:**

### v0.3.0-alpha.1: Error Type Only

- Implement PfcpError
- Leave newtype wrappers for later
- Timeline: 6-8 days
- Less breaking, faster release

### v0.3.0 Final: Add Newtypes

- Add newtype wrappers
- Remove deprecated methods
- Timeline: +2-3 days
- Complete the vision

**Benefit:** Faster iteration, more feedback cycles
**Drawback:** Two breaking change cycles instead of one

---

## üìö Documentation Deliverables

1. **Migration Guide** (`docs/guides/v0.3.0-migration.md`)
   - Breaking changes list
   - Before/after code examples
   - Common migration patterns
   - Troubleshooting

2. **Error Handling Guide** (`docs/guides/error-handling.md`)
   - PfcpError variants explained
   - Error recovery patterns
   - Best practices
   - 3GPP Cause mapping

3. **Type Safety Guide** (`docs/guides/type-safety.md`)
   - Newtype wrapper benefits
   - Usage examples
   - Performance implications

4. **CHANGELOG.md**
   - Comprehensive breaking changes section
   - Migration instructions
   - New features

---

## üöÄ Next Steps

**To proceed with v0.3.0:**

1. **Review this plan** - Get stakeholder buy-in
2. **Create feature branch** - `git checkout -b feature/v0.3.0`
3. **Start Phase 1** - Begin with PfcpError design
4. **Track progress** - Update this document with completion status
5. **Community communication** - Announce plans in GitHub discussions

**Alternative:**

- **Defer v0.3.0** - Let v0.2.x mature longer (3-6 months)
- **Focus on features** - Add new PFCP extensions, improvements
- **Gather feedback** - See what users actually need

---

## ü§ù Stakeholder Review

**Questions for Decision:**

1. **Timeline:** Is 8-10 weeks acceptable? Or defer longer?
2. **Scope:** All features together, or incremental (alpha releases)?
3. **Priority:** Is this higher priority than new features?
4. **Community:** Should we poll users about breaking changes?

**Approval:**

- [ ] Maintainer approved
- [ ] Timeline approved
- [ ] Scope approved
- [ ] Ready to proceed

---

**Document Status:** Draft - Awaiting Review
**Last Updated:** 2025-12-14
**Next Review:** Before starting implementation
