# v0.3.0 Release Plan - Breaking Changes

**Created:** 2025-12-14
**Last Updated:** 2026-02-04
**Target Release:** Q1-Q2 2026
**Type:** MAJOR - Breaking Changes
**Status:** Ready for Implementation

---

## ‚úÖ **STATUS UPDATE (2026-02-04)**

**The Custom Error Type (PfcpError) migration is 100% COMPLETE!**

All error handling work has been completed in the v0.2.x series. The v0.3.0 release can now focus on the remaining breaking changes.

### üéâ What's Complete:

**PfcpError Migration (100% DONE):**
- ‚úÖ PfcpError enum with 8 variants (src/error.rs, 1,369 lines)
- ‚úÖ 100% IE layer coverage - ALL unmarshal methods use PfcpError
- ‚úÖ 100% message layer coverage - all 25 message types migrated
- ‚úÖ 100% builder coverage - all builders use PfcpError
- ‚úÖ Core infrastructure - Ie::unmarshal, IeIterator, accessor methods
- ‚úÖ Comparison module migrated
- ‚úÖ All std::io::Error returns converted to PfcpError
- ‚úÖ 2,081 tests passing
- ‚úÖ Documentation updated (CLAUDE.md, error-handling.md)

**Documentation moved to completed/:**
- `docs/analysis/completed/custom-error-type.md`
- `docs/analysis/completed/message-layer-pfcp-error-migration.md`

### üéØ v0.3.0 Scope (Remaining Work):

- ‚úÖ Newtype Wrappers (Seid, SequenceNumber, Teid) - **PRIMARY FEATURE**
- ‚úÖ Remove Deprecated Methods (find_ie, find_all_ies)
- ‚úÖ Documentation & Migration Guide

### üìä Timeline:

**Development Effort:** 4-6 days
- Phase 1 (Newtypes): 2-3 days
- Phase 2 (Cleanup): 1-2 days
- Phase 3 (Documentation): 1 day

**Community Review:** 2-4 weeks (release candidate period)

---

## üìã Executive Summary

v0.3.0 will be the **first major breaking release** since v0.2.0, focusing on **type safety**. The error handling migration was completed ahead of schedule in v0.2.x, so this release focuses on newtype wrappers and API cleanup.

**Goals:**

1. ‚úÖ **PfcpError migration** - COMPLETE (done in v0.2.x)
2. üéØ **Add newtype wrappers** for type-safe primitives (Seid, SequenceNumber, Teid)
3. üéØ **Remove deprecated methods** from v0.2.x (find_ie, find_all_ies)
4. ‚úÖ Maintain 100% test coverage
5. üéØ Provide clear migration guide

**Timeline:** 4-6 days development + 2-4 weeks community feedback
**Risk:** LOW (well-scoped, error work already done)

---

## üéØ Core Features

### 1. Custom Error Type (`PfcpError`) - ‚úÖ **100% COMPLETE**

**Status:** Fully implemented in v0.2.x series (completed 2026-02-04)

**What's Done:**
- ‚úÖ PfcpError enum with 8 variants (src/error.rs, 1,369 lines)
- ‚úÖ 100% IE layer - all unmarshal methods migrated
- ‚úÖ 100% message layer - all 25 message types migrated
- ‚úÖ 100% builder layer - all builders use PfcpError
- ‚úÖ Core infrastructure - Ie::unmarshal, IeIterator, accessor methods
- ‚úÖ Comparison module - semantic.rs, builder.rs, compare.rs
- ‚úÖ 3GPP Cause code mapping (to_cause_code() method)
- ‚úÖ Rich error context with structured variants
- ‚úÖ 2,081 tests passing
- ‚úÖ Zero std::io::Error returns in IE/message/builder layers

**Documentation:** See `docs/analysis/completed/custom-error-type.md` for full implementation history.

**No remaining work for v0.3.0** - this feature is complete!

---

### Original Feature Description (Mostly Implemented):

**Current Problem:**

```rust
// ‚ùå All errors are generic io::Error
pub fn unmarshal(data: &[u8]) -> Result<Self, io::Error> {
    Err(io::Error::new(io::ErrorKind::InvalidData, "Missing PDR ID"))
}

// ‚ùå Users must parse error strings (brittle!)
match msg.unmarshal(data) {
    Err(e) if e.to_string().contains("Missing PDR ID") => { /* ... */ }
}
```

**Proposed Solution:**

```rust
// ‚úÖ Structured error type with rich context
pub enum PfcpError {
    /// IE parsing errors
    IeParseError {
        ie_type: IeType,
        reason: String,
        offset: Option<usize>,
    },

    /// Missing mandatory IE
    MissingMandatoryIe {
        ie_type: IeType,
        message_type: Option<MsgType>,
    },

    /// Invalid field value
    InvalidValue {
        field: String,
        expected: String,
        got: String,
    },

    /// Validation errors (builders)
    ValidationError {
        message: String,
    },

    /// UTF-8 encoding errors
    EncodingError {
        source: std::str::Utf8Error,
    },

    /// Underlying I/O errors
    IoError {
        source: io::Error,
    },
}

impl std::error::Error for PfcpError { /* ... */ }
impl Display for PfcpError { /* ... */ }
impl From<io::Error> for PfcpError { /* ... */ }
impl From<std::str::Utf8Error> for PfcpError { /* ... */ }
```

**Benefits:**

- ‚úÖ **Pattern matching** on error types
- ‚úÖ **Error recovery** - handle specific cases
- ‚úÖ **Better debugging** - structured context
- ‚úÖ **3GPP mapping** - can map to PFCP Cause codes
- ‚úÖ **Error chains** - preserve error context

**Implementation Leverage:**

- ‚úÖ v0.2.4 already has error message constants in `src/error.rs`
- ‚úÖ Just need to add enum and migrate call sites
- ‚úÖ Message constants directly map to error variants

**Effort:** 3-4 days
**Files Affected:** ~150 files (all marshal/unmarshal implementations)
**Breaking:** Yes (changes all `Result<T, io::Error>` ‚Üí `Result<T, PfcpError>`)

---

---

### 2. Newtype Wrappers - **NOW PRIMARY FEATURE FOR v0.3.0** üéØ

**Current Problem:**

```rust
// ‚ùå Easy to swap arguments (both are primitives)
SessionEstablishmentRequest::new(1234, 5678);  // Which is SEID? Which is sequence?
SessionEstablishmentRequest::new(5678, 1234);  // Compiles but wrong!

// ‚ùå No semantic meaning
let seid: u64 = 0x123456789ABCDEF0;
let teid: u32 = 0x12345678;
let seq: u32 = 42;
// All primitives - easy to mix up
```

**Proposed Solution:**

```rust
// ‚úÖ Type-safe newtypes
#[derive(Debug, Clone, Copy, PartialEq, Eq, PartialOrd, Ord, Hash)]
pub struct Seid(pub u64);

#[derive(Debug, Clone, Copy, PartialEq, Eq, PartialOrd, Ord, Hash)]
pub struct SequenceNumber(pub u32);

#[derive(Debug, Clone, Copy, PartialEq, Eq, PartialOrd, Ord, Hash)]
pub struct Teid(pub u32);

impl Seid {
    pub const fn new(value: u64) -> Self { Self(value) }
    pub const fn value(&self) -> u64 { self.0 }
}

// ‚úÖ Compiler prevents swapping
SessionEstablishmentRequest::new(
    Seid::new(0x123456789ABCDEF0),
    SequenceNumber::new(42)
);  // Type-safe!

SessionEstablishmentRequest::new(
    SequenceNumber::new(42),  // ‚ùå Compile error!
    Seid::new(0x123456789ABCDEF0)
);
```

**Types to Wrap:**

| Type | Inner | Priority | Usage |
|------|-------|----------|-------|
| `Seid` | `u64` | HIGH | Session Endpoint ID - used in 12+ messages |
| `SequenceNumber` | `u32` | HIGH | Message sequence - used in all messages |
| `Teid` | `u32` | HIGH | Tunnel Endpoint ID - F-TEID IE |
| `Priority` | `u8` | MEDIUM | QoS priority values |

**Note:** `Precedence` already exists as a proper type! ‚úÖ

**Benefits:**

- ‚úÖ **Compile-time safety** - prevent argument swapping
- ‚úÖ **Self-documenting** - clear semantic meaning
- ‚úÖ **Validation** - can add constructors that validate ranges
- ‚úÖ **Domain logic** - can add impl blocks for conversions

**Effort:** 1-2 days
**Files Affected:** ~40 files (message constructors, builders)
**Breaking:** Yes (changes constructor signatures)

---

### 3. Remove Deprecated Methods - LOW PRIORITY

**Cleanup deprecated APIs from v0.2.x:**

```rust
// Remove these deprecated methods (added in v0.2.2):
- Message::find_ie()         // Use: ies(ie_type).next()
- Message::find_all_ies()    // Use: ies(ie_type).collect()
```

**Deprecation Timeline:**

- v0.2.2 (2025-12-05): Methods marked `#[deprecated]`
- v0.2.3-v0.2.5: Deprecation warnings guide users
- v0.3.0: Remove deprecated methods entirely

**Effort:** 0.5 days (straightforward removal)
**Files Affected:** ~30 files (message types + trait)
**Breaking:** Yes (removes deprecated methods)

---

## üìÖ Implementation Plan

### Phase 0: Custom Error Type - ‚úÖ COMPLETE

**All tasks completed in v0.2.x series (2026-01-25 through 2026-02-04):**

- [x] PfcpError enum designed and implemented (src/error.rs)
- [x] Display, Error, From implementations
- [x] All IE files migrated (100+ files)
- [x] All message files migrated (25 message types)
- [x] All builders migrated
- [x] Core infrastructure migrated (Ie::unmarshal, IeIterator)
- [x] Comparison module migrated
- [x] Tests updated and passing (2,081 tests)
- [x] Documentation updated

**See:** `docs/analysis/completed/custom-error-type.md` for full history.

---

### Phase 1: Newtype Wrappers (2-3 days)

**Task 2.1: Create Newtype Definitions (0.5 days)**

- [ ] Create `src/types.rs` with newtype wrappers
- [ ] Add `Seid`, `SequenceNumber`, `Teid`, `Priority`
- [ ] Implement std traits (Debug, Clone, Eq, Ord, Hash)
- [ ] Add const constructors and accessors
- [ ] Add comprehensive tests

**Task 2.2: Migrate Message Constructors (1 day)**

- [ ] Update all 26 message type constructors
- [ ] Update message builders
- [ ] Update `Message` trait if needed
- [ ] Run tests after each message type

**Task 2.3: Migrate IE Constructors (0.5 days)**

- [ ] Update F-TEID (uses Teid)
- [ ] Update F-SEID (uses Seid)
- [ ] Update other IEs as needed
- [ ] Run tests

**Task 2.4: Update Examples (0.5 days)**

- [ ] Update all examples with new types
- [ ] Add type-safety demonstration examples
- [ ] Update documentation

**Phase 2 Total:** 2-3 days

---

### Phase 3: Cleanup & Polish (Week 2-3)

**Task 3.1: Remove Deprecated Methods (0.5 days)**

- [ ] Remove `find_ie()` and `find_all_ies()`
- [ ] Update any remaining call sites
- [ ] Run full test suite

**Task 3.2: Documentation (1 day)**

- [ ] Write migration guide (`docs/guides/v0.3.0-migration.md`)
- [ ] Update CHANGELOG.md
- [ ] Update README with breaking changes
- [ ] Update API documentation
- [ ] Add "What's New in v0.3.0" guide

**Task 3.3: Testing & Validation (1 day)**

- [ ] Run full test suite (all 2,367 tests)
- [ ] Run benchmarks (ensure no regression)
- [ ] Manual testing of examples
- [ ] Compile with latest Rust stable

**Task 3.4: Community Review (2-4 weeks)**

- [ ] Create v0.3.0-rc.1 release candidate
- [ ] Announce in discussions/issues
- [ ] Gather feedback
- [ ] Fix any issues found
- [ ] Create v0.3.0-rc.2 if needed

**Phase 3 Total:** 2-3 days + 2-4 weeks feedback

---

## üìä Effort Summary

| Phase | Task | Effort | Risk | Status |
|-------|------|--------|------|--------|
| **Phase 0** | Custom Error Type (PfcpError) | - | - | **‚úÖ DONE in v0.2.x** |
| **Phase 1** | Newtype Wrappers (Seid, Seq, Teid) | 2-3 days | LOW | üéØ Ready |
| **Phase 2** | Remove Deprecated Methods | 0.5-1 day | LOW | üéØ Ready |
| **Phase 3** | Documentation & Migration Guide | 1-2 days | LOW | üéØ Ready |
| **Community** | Review Period (RC releases) | 2-4 weeks | LOW | Pending |
| **Total** | Development | **4-6 days** | **LOW** | Ready to start |

**Note:** PfcpError migration was completed ahead of schedule, significantly reducing v0.3.0 scope!

**Calendar Timeline:**

- Week 1: Phase 1 (Newtype Wrappers)
- Week 1-2: Phase 2 (Remove Deprecated Methods)
- Week 2: Phase 3 (Documentation & Migration Guide)
- Week 3-6: Community review & feedback (RC releases)
- Week 6-7: Final release

**Target Release:** 6-8 weeks from start (Q1-Q2 2026)

---

## üéØ Success Criteria

### Must Have ‚úÖ

- [x] PfcpError migration complete (2,081 tests passing)
- [ ] Newtype wrappers implemented and tested
- [ ] All 2,100+ tests passing
- [ ] Zero clippy warnings
- [ ] All examples compile and run
- [ ] Migration guide is complete and tested
- [ ] CHANGELOG documents all breaking changes
- [ ] Performance: No regressions (benchmarks within 5%)

### Should Have üìã

- [ ] Community feedback incorporated
- [ ] At least 2 weeks of rc testing
- [ ] Migration tested on real projects
- [ ] Error messages are helpful and consistent

### Nice to Have üåü

- [ ] Error type examples in docs/guides
- [ ] YouTube video explaining migration
- [ ] Blog post about type safety improvements

---

## ‚ö†Ô∏è Risks & Mitigation

### Risk 1: Breaking Changes Impact Users
**Likelihood:** HIGH
**Impact:** MEDIUM
**Mitigation:**

- ‚úÖ Provide comprehensive migration guide
- ‚úÖ Release candidate period for feedback
- ‚úÖ Clear deprecation timeline (v0.2.2 ‚Üí v0.3.0)
- ‚úÖ Document all breaking changes in CHANGELOG

### Risk 2: Error Type Complexity
**Likelihood:** MEDIUM
**Impact:** MEDIUM
**Mitigation:**

- ‚úÖ Leverage existing error message constants from v0.2.4
- ‚úÖ Start with simple enum, can expand later
- ‚úÖ Provide From<io::Error> for backward compat in some places

### Risk 3: Performance Regression
**Likelihood:** LOW
**Impact:** HIGH
**Mitigation:**

- ‚úÖ Newtype wrappers are zero-cost
- ‚úÖ Error type uses enums (efficient)
- ‚úÖ Run benchmarks before/after
- ‚úÖ Only accept if performance within 5%

### Risk 4: Community Resistance
**Likelihood:** LOW
**Impact:** MEDIUM
**Mitigation:**

- ‚úÖ Clear communication about benefits
- ‚úÖ Migration guide with examples
- ‚úÖ RC period for feedback
- ‚úÖ Be willing to adjust based on feedback

---

## üì¶ Migration Guide Preview

### For Users of rs-pfcp

**Updating Error Handling:**

```rust
// Before (v0.2.x)
match msg.unmarshal(data) {
    Ok(msg) => process(msg),
    Err(e) => eprintln!("Error: {}", e),
}

// After (v0.3.0) - Option 1: Simple migration
match msg.unmarshal(data) {
    Ok(msg) => process(msg),
    Err(e) => eprintln!("Error: {}", e),  // Still works!
}

// After (v0.3.0) - Option 2: Structured handling
use rs_pfcp::error::PfcpError;

match msg.unmarshal(data) {
    Ok(msg) => process(msg),
    Err(PfcpError::MissingMandatoryIe { ie_type, .. }) => {
        eprintln!("Missing required IE: {:?}", ie_type);
        // Can send appropriate PFCP error response
    }
    Err(PfcpError::IeParseError { ie_type, reason, .. }) => {
        eprintln!("Failed to parse {:?}: {}", ie_type, reason);
    }
    Err(e) => eprintln!("Other error: {}", e),
}
```

**Updating Constructors:**

```rust
// Before (v0.2.x)
let req = SessionEstablishmentRequest::new(seid_u64, seq_u32);

// After (v0.3.0)
use rs_pfcp::types::{Seid, SequenceNumber};
let req = SessionEstablishmentRequest::new(
    Seid::new(seid_u64),
    SequenceNumber::new(seq_u32)
);

// Or use From trait
let req = SessionEstablishmentRequest::new(
    seid_u64.into(),  // Implements From<u64> for Seid
    seq_u32.into()    // Implements From<u32> for SequenceNumber
);
```

**Updating Iterator Usage:**

```rust
// Before (v0.2.x) - deprecated but still works
let pdr = msg.find_ie(IeType::CreatePdr);

// After (v0.3.0) - use iterator API
let pdr = msg.ies(IeType::CreatePdr).next();
```

---

## üîÑ Alternative: Incremental Approach

**If 10-14 days is too much at once:**

### v0.3.0-alpha.1: Error Type Only

- Implement PfcpError
- Leave newtype wrappers for later
- Timeline: 6-8 days
- Less breaking, faster release

### v0.3.0 Final: Add Newtypes

- Add newtype wrappers
- Remove deprecated methods
- Timeline: +2-3 days
- Complete the vision

**Benefit:** Faster iteration, more feedback cycles
**Drawback:** Two breaking change cycles instead of one

---

## üìö Documentation Deliverables

1. **Migration Guide** (`docs/guides/v0.3.0-migration.md`)
   - Breaking changes list
   - Before/after code examples
   - Common migration patterns
   - Troubleshooting

2. **Error Handling Guide** (`docs/guides/error-handling.md`)
   - PfcpError variants explained
   - Error recovery patterns
   - Best practices
   - 3GPP Cause mapping

3. **Type Safety Guide** (`docs/guides/type-safety.md`)
   - Newtype wrapper benefits
   - Usage examples
   - Performance implications

4. **CHANGELOG.md**
   - Comprehensive breaking changes section
   - Migration instructions
   - New features

---

## üöÄ Next Steps

**To proceed with v0.3.0:**

1. ‚úÖ **PfcpError migration** - COMPLETE
2. **Create feature branch** - `git checkout -b feature/v0.3.0`
3. **Implement newtype wrappers** - Seid, SequenceNumber, Teid
4. **Remove deprecated methods** - find_ie, find_all_ies
5. **Write migration guide** - docs/guides/v0.3.0-migration.md
6. **Update CHANGELOG** - Document breaking changes
7. **Release candidate** - v0.3.0-rc.1 for community testing
8. **Final release** - v0.3.0 after feedback period

---

## ü§ù Stakeholder Review

**Completed Decisions:**

- [x] PfcpError implementation approach - Done in v0.2.x
- [x] Error variants design - 8 variants implemented
- [x] Migration strategy - Batched approach successful

**Remaining Decisions:**

1. **Timeline:** When to start newtype wrapper implementation?
2. **Scope:** Include Priority newtype or defer?
3. **Naming:** Seid vs SessionEndpointId?

**Approval:**

- [x] PfcpError design approved (implemented)
- [ ] Newtype wrapper design approved
- [ ] Ready to proceed with v0.3.0

---

**Document Status:** Ready for Implementation
**Last Updated:** 2026-02-04
**Next Action:** Start Phase 1 (Newtype Wrappers)
