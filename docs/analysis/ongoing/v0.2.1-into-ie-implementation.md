# v0.2.1: IntoIe Trait Expansion - Implementation Plan

**Created:** 2025-12-03
**Status:** In Progress
**Target:** v0.2.1
**Breaking:** No (additive only)

---

## Current State

**Existing IntoIe Implementations:**
- ✅ `SystemTime` → RecoveryTimeStamp IE
- ✅ `Ipv4Addr` → SourceIpAddress IE
- ✅ `Ipv6Addr` → SourceIpAddress IE
- ✅ `IpAddr` → SourceIpAddress IE
- ✅ `&str` → NodeId IE (FQDN)
- ✅ `String` → NodeId IE (FQDN)

**Usage:** Primarily in builders and message construction

---

## Patterns Found in Examples

### 1. FSEID Construction (Most Common)
```rust
// Current verbose pattern (8 occurrences)
let fseid = Fseid::new(seid, Some(ipv4), None);

// Proposed ergonomic pattern
let fseid: Fseid = (seid, ipv4).into();
// Or for IE directly:
builder.fseid((seid, ipv4))  // If builder accepts IntoIe
```

### 2. Duration/Timer Conversions
```rust
// Current
let timer = EthernetInactivityTimer::from_secs(300);
let ie = timer.to_ie();

// Proposed
let ie = Duration::from_secs(300).into_ie();  // For timer IEs
```

### 3. Grouped IEs
```rust
// Current
let pdr = CreatePdr::builder()...build()?;
builder.create_pdrs(vec![pdr.to_ie()])

// Already good, but ensure consistency
```

---

## Proposed New Implementations

### Priority 1: High-Value Ergonomics

#### 1. Tuple to FSEID
```rust
/// (u64, Ipv4Addr) → F-SEID IE (IPv4 only)
impl IntoIe for (u64, Ipv4Addr) {
    fn into_ie(self) -> Ie {
        use crate::ie::fseid::Fseid;
        let (seid, ip) = self;
        Fseid::new(seid, Some(ip), None).to_ie()
    }
}

/// (u64, Ipv6Addr) → F-SEID IE (IPv6 only)
impl IntoIe for (u64, Ipv6Addr) {
    fn into_ie(self) -> Ie {
        use crate::ie::fseid::Fseid;
        let (seid, ip) = self;
        Fseid::new(seid, None, Some(ip)).to_ie()
    }
}

/// (u64, IpAddr) → F-SEID IE (dispatches based on IP version)
impl IntoIe for (u64, IpAddr) {
    fn into_ie(self) -> Ie {
        let (seid, ip) = self;
        match ip {
            IpAddr::V4(v4) => (seid, v4).into_ie(),
            IpAddr::V6(v6) => (seid, v6).into_ie(),
        }
    }
}
```

#### 2. u32 for simple ID IEs
```rust
/// u32 → PDR ID IE (common simple wrapper)
impl IntoIe for u32 {
    fn into_ie(self) -> Ie {
        use crate::ie::pdr_id::PdrId;
        PdrId::new(self).to_ie()
    }
}
```

**Note:** This is controversial - u32 is too generic. Better to be explicit.
**Decision:** SKIP - too ambiguous, multiple IEs use u32

#### 3. u8 for simple value IEs
**Decision:** SKIP - same issue as u32, too ambiguous

---

## Implementation Strategy

### Phase 1: Tuple Conversions (High Value)
**Rationale:** Tuples are unambiguous and high-value

1. ✅ `(u64, Ipv4Addr)` → F-SEID IE
2. ✅ `(u64, Ipv6Addr)` → F-SEID IE
3. ✅ `(u64, IpAddr)` → F-SEID IE

**Impact:** Makes FSEID construction much more ergonomic
**Risk:** Low - tuple types are specific

### Phase 2: Consider Duration (Deferred)
**Problem:** Which IE type?
- Timer?
- EthernetInactivityTimer?
- GracefulReleasePeriod?
- Others?

**Decision:** SKIP for v0.2.1 - too ambiguous without context
**Alternative:** Keep type-specific `from_secs()` constructors

### Phase 3: String Types (Maybe)
**Already have:** `&str` → NodeId

**Could add:**
- `&str` → ApnDnn
- `&str` → NetworkInstance
- `&str` → ApplicationId

**Problem:** Same string, many possible IE types
**Decision:** SKIP - ambiguous, use explicit constructors

---

## What We're Actually Implementing

### Final List for v0.2.1:

1. **Tuple to FSEID conversions** (3 implementations)
   - Most common pattern in examples
   - Unambiguous tuple signature
   - High ergonomic value

**Total:** 3 new IntoIe implementations

---

## Testing Plan

```rust
#[cfg(test)]
mod tests {
    use super::*;
    use std::net::{IpAddr, Ipv4Addr, Ipv6Addr};

    #[test]
    fn test_into_ie_tuple_fseid_ipv4() {
        let ipv4 = Ipv4Addr::new(10, 0, 0, 1);
        let ie = (0x123456789ABCDEFu64, ipv4).into_ie();

        assert_eq!(ie.ie_type, IeType::Fseid);

        let fseid = Fseid::unmarshal(&ie.payload).unwrap();
        assert_eq!(fseid.seid, 0x123456789ABCDEFu64);
        assert_eq!(fseid.ipv4_address, Some(ipv4));
        assert_eq!(fseid.ipv6_address, None);
    }

    #[test]
    fn test_into_ie_tuple_fseid_ipv6() {
        let ipv6 = Ipv6Addr::new(0x2001, 0xdb8, 0, 0, 0, 0, 0, 1);
        let ie = (0x123456789ABCDEFu64, ipv6).into_ie();

        assert_eq!(ie.ie_type, IeType::Fseid);

        let fseid = Fseid::unmarshal(&ie.payload).unwrap();
        assert_eq!(fseid.seid, 0x123456789ABCDEFu64);
        assert_eq!(fseid.ipv4_address, None);
        assert_eq!(fseid.ipv6_address, Some(ipv6));
    }

    #[test]
    fn test_into_ie_tuple_fseid_ipaddr_v4() {
        let ip = IpAddr::V4(Ipv4Addr::new(10, 0, 0, 1));
        let ie = (0x123456789ABCDEFu64, ip).into_ie();

        assert_eq!(ie.ie_type, IeType::Fseid);

        let fseid = Fseid::unmarshal(&ie.payload).unwrap();
        assert_eq!(fseid.seid, 0x123456789ABCDEFu64);
        assert!(fseid.ipv4_address.is_some());
    }

    #[test]
    fn test_into_ie_tuple_fseid_ipaddr_v6() {
        let ip = IpAddr::V6(Ipv6Addr::new(0x2001, 0xdb8, 0, 0, 0, 0, 0, 1));
        let ie = (0x123456789ABCDEFu64, ip).into_ie();

        assert_eq!(ie.ie_type, IeType::Fseid);

        let fseid = Fseid::unmarshal(&ie.payload).unwrap();
        assert_eq!(fseid.seid, 0x123456789ABCDEFu64);
        assert!(fseid.ipv6_address.is_some());
    }
}
```

---

## Documentation Updates

### 1. IntoIe Trait Doc Comment
Add examples showing tuple conversions:

```rust
/// # Tuple Conversions
///
/// ```
/// use rs_pfcp::ie::IntoIe;
/// use std::net::Ipv4Addr;
///
/// // FSEID from tuple (SEID + IP)
/// let ie = (0x1234u64, Ipv4Addr::new(10, 0, 0, 1)).into_ie();
/// ```
```

### 2. FSEID Documentation
Update Fseid docs to mention IntoIe:

```rust
/// # Ergonomic Construction
///
/// For simple cases, use tuple conversion:
/// ```
/// let fseid_ie = (seid, ip_addr).into_ie();
/// ```
```

---

## Migration Impact

**Breaking:** No
**Additive:** Yes
**User Impact:** Positive - optional convenience

**Before (still works):**
```rust
let fseid = Fseid::new(seid, Some(ipv4), None);
builder.fseid(fseid)
```

**After (new option):**
```rust
builder.fseid((seid, ipv4))  // If builder updated
// OR
let ie = (seid, ipv4).into_ie();
builder.fseid(ie)
```

---

## Future Considerations

### For v0.2.2 or later:

1. **Builder Method Updates**
   - Update builder methods to accept `impl Into<Fseid>`
   - Example: `.fseid(impl Into<Fseid>)` accepts both Fseid and tuples

2. **More Tuple Patterns**
   - Only add if pattern appears 5+ times in examples
   - Must be unambiguous

3. **Avoid Over-Magic**
   - Don't add IntoIe for every possible conversion
   - Keep explicit constructors as primary API
   - IntoIe is sugar, not replacement

---

## Success Criteria

- [x] 3 new IntoIe implementations
- [ ] 4 new tests (one per implementation + edge cases)
- [ ] Documentation updated
- [ ] No breaking changes
- [ ] All existing tests pass
- [ ] Code review: not too magical

---

## Timeline

- **Research & Planning:** 0.5 hours (done)
- **Implementation:** 0.5 hours
- **Testing:** 0.5 hours
- **Documentation:** 0.5 hours
- **Review:** 0.5 hours

**Total:** ~2.5 hours (well under 1 day estimate)

---

**Status:** Ready to implement
**Next:** Add implementations to `src/ie/mod.rs`
